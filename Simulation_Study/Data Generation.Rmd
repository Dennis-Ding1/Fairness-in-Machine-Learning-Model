---
title: "Data Generation"
output: html_document
---

```{r}
# ---------------------------
# Simulated Survival Dataset Generator (with heterogeneous Normal covariates)
# ---------------------------

generate_data <- function(
  n = 2000,
  pA = 0.5,
  mu_X = c(60, 120),          # mean for each covariate
  sd_X = c(10, 15),        # sd for each covariate
  beta_X = c(0.03, 0.014), # coefficients for covariates
  beta_A = 0,                 # group effect
  lambda = 0.05,               # baseline rate for Weibull
  k = 1.5,                    # shape parameter
  mu = 0.1,                   # baseline censoring rate
  alpha = 0,                  # censoring dependence
  Cmax_A0 = 10,              # max follow-up (group 0)
  Cmax_A1 = 10,              # max follow-up (group 1)
  seed = 123
) {
  set.seed(seed)
  
  pX <- length(mu_X)
  if (length(sd_X) != pX | length(beta_X) != pX)
    stop("Lengths of mu_X, sd_X, and beta_X doesn't match.")
  
  # ---- Sensitive attribute ----
  A <- rbinom(n, 1, pA)
  
  # ---- Covariates ----
  X <- matrix(NA, nrow = n, ncol = pX)
  for (j in 1:pX) {
    X[, j] <- rnorm(n, mean = mu_X[j], sd = sd_X[j])
  }
  colnames(X) <- paste0("X", 1:pX)
  
  # ---- Linear predictor ----
  eta <- beta_A * A + X %*% beta_X
  
  # ---- True event time (Weibull proportional hazards) ----
  U <- runif(n)
  T_true <- ((-log(U)) / (lambda * exp(eta)))^(1 / k)
  
  # ---- Censoring time (possibly informative) ----
  C <- rexp(n, rate = mu * exp(alpha * eta))
  
  # ---- Group-specific max follow-up ----
  Cmax <- ifelse(A == 0, Cmax_A0, Cmax_A1)
  
  # ---- Observed data ----
  Y <- pmin(T_true, C, Cmax)
  Delta <- as.numeric(T_true <= pmin(C, Cmax))
  
  data <- data.frame(
    id = 1:n,
    A = A,
    X,
    T_true = T_true,
    C = C,
    Cmax = Cmax,
    Y = Y,
    Delta = Delta
  )
  
  return(data)
}



```

```{r}
# ---------------------------
# Example usage
# ---------------------------

mu_X = c(60, 120)
sd_X = c(10, 15)
beta_X = c(0.03, 0.014)

# Scenario I: all assumptions hold
data_I <- generate_data(
  n = 2000,
  mu_X = mu_X,
  sd_X = sd_X,
  beta_X = beta_X,
  beta_A = 0,
  alpha = 0,
  Cmax_A0 = 10,
  Cmax_A1 = 10
)

# Scenario II: violation of assumptions
data_II <- generate_data(
  n = 2000,
  mu_X = mu_X,
  sd_X = sd_X,
  beta_X = beta_X,
  beta_A = 0.5,
  alpha = 0.5,
  Cmax_A0 = 15,
  Cmax_A1 = 10
)

# Quick check
head(data_I)
head(data_II)


```

```{r}
# 假设 generate_fast_data() 已经在环境中定义
dat <- data_I

# ---- 基本结构检查 ----
cat("Dataset size:", nrow(dat), "\n")
cat("Columns:", names(dat), "\n")

summary(dat)

# ---- 1️⃣ 检查删失率 ----
cat("\nOverall censoring rate:\n")
mean(dat$Delta == 0)

cat("\nCensoring rate by group (A=0, A=1):\n")
tapply(dat$Delta == 0, dat$A, mean)

# ---- 2️⃣ 检查生存时间分布 ----
library(ggplot2)

ggplot(dat, aes(x = Y, fill = factor(A))) +
  geom_histogram(alpha = 0.5, bins = 40, position = "identity") +
  labs(title = "Observed Time Distribution by Group",
       x = "Observed Time (Y)",
       fill = "Group A") +
  theme_minimal()

# ---- 3️⃣ 检查删失 vs. 事件 ----
ggplot(dat, aes(x = Y, fill = factor(Delta))) +
  geom_histogram(alpha = 0.6, bins = 40, position = "identity") +
  labs(title = "Events (Δ=1) vs Censored (Δ=0)",
       x = "Observed Time",
       fill = "Event Indicator") +
  theme_minimal()

# ---- 4️⃣ 检查协变量分布（可选）----
ggplot(dat, aes(x = X1, fill = factor(A))) +
  geom_density(alpha = 0.4) +
  labs(title = "Age Distribution by Group", fill = "Group A") +
  theme_minimal()

ggplot(dat, aes(x = X2, fill = factor(A))) +
  geom_density(alpha = 0.4) +
  labs(title = "SBP Distribution by Group", fill = "Group A") +
  theme_minimal()

# ---- 5️⃣ 快速验证删失机制是否如预期 ----
aggregate(cbind(Y, Delta) ~ A, data = dat, FUN = mean)

```

```{r}
write.csv(data_I, "data/data_I.csv", row.names = FALSE)
write.csv(data_II, "data/data_II.csv", row.names = FALSE)
```

















  